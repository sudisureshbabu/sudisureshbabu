{
	"name": "8_explore_trip_data_green_parquet",
	"properties": {
		"folder": {
			"name": "nyc_taxi/Discovery"
		},
		"content": {
			"query": "use nyc_taxi_discovery;\n\n-- This is auto-generated code\nSELECT\n    TOP 100 *\nFROM\n    OPENROWSET(\n        BULK 'trip_data_green_parquet/year=2020/month=01/',\n        FORMAT = 'PARQUET',\n        DATA_SOURCE = 'nyc_taxi_data_raw'\n    ) AS [result]\n;\n-- identify the data types of the parquet file\nexec sp_describe_first_result_set N'\nSELECT\n    TOP 100 *\nFROM\n    OPENROWSET(\n        BULK ''trip_data_green_parquet/year=2020/month=01/'',\n        FORMAT = ''PARQUET'',\n        DATA_SOURCE = ''nyc_taxi_data_raw''\n    ) AS [result]\n    '\n    ;\n\n--- define column and data type\nSELECT\n    TOP 100 *\nFROM\n    OPENROWSET(\n        BULK 'trip_data_green_parquet/year=2020/month=01/',\n        FORMAT = 'PARQUET',\n        DATA_SOURCE = 'nyc_taxi_data_raw'\n    ) WITH(\nVendorID\t\t\t\t int,\nlpep_pickup_datetime     datetime2(7),\nlpep_dropoff_datetime    datetime2(7),\nstore_and_fwd_flag       varchar(1),\nRatecodeID               int,\nPULocationID             int,\nDOLocationID             int,\npassenger_count          int,\ntrip_distance            float,\nfare_amount              float,\nextra                    float,\nmta_tax                  float,\ntip_amount               float,\ntolls_amount             float,\nehail_fee                int,\nimprovement_surcharge    float,\ntotal_amount             float,\npayment_type             int,\ntrip_type                int,\ncongestion_surcharge     float\n    )\n    AS [result]\n;\n--- selected columns only for less amount of data to be processed\nSELECT\n    TOP 100 *\nFROM\n    OPENROWSET(\n        BULK 'trip_data_green_parquet/year=2020/month=01/',\n        FORMAT = 'PARQUET',\n        DATA_SOURCE = 'nyc_taxi_data_raw'\n    ) WITH(\ntip_amount               float,\ntrip_type                int,\ncongestion_surcharge     float\n    )\n    AS [result]\n;\n/*\n    Assignment \n    -----------\n    1) query from folders using wildcard characters\n    2) use filename function \n    3) query from subfolders\n    4) use filepath function to select only from certain partitions\n*/\n\n--- Query from folders using wildcard characters\n\nSELECT\n    TOP 100 *\nFROM\n    OPENROWSET(\n        BULK 'trip_data_green_parquet/year=2020/month=01/*.parquet',\n        FORMAT = 'PARQUET',\n        DATA_SOURCE = 'nyc_taxi_data_raw'\n    ) AS [result]\n;\n\n\nSELECT\n    TOP 100 *\nFROM\n    OPENROWSET(\n        BULK 'trip_data_green_parquet/year=2020/month=*/*.parquet',\n        FORMAT = 'PARQUET',\n        DATA_SOURCE = 'nyc_taxi_data_raw'\n    ) AS [result]\n;\n\nSELECT\n    TOP 100 *\nFROM\n    OPENROWSET(\n        BULK 'trip_data_green_parquet/year=*/month=*/*.parquet',\n        FORMAT = 'PARQUET',\n        DATA_SOURCE = 'nyc_taxi_data_raw'\n    ) AS [result]\n;\n\n\n-- Get data along with file name using meta data function filename()\nselect \nTOP 100\ngtd.filename() as filename ,\ngtd.*\nFrom  OPENROWSET(\n        BULK 'trip_data_green_parquet/year=*/month=*/*.parquet',\n        FORMAT = 'PARQUET',\n        DATA_SOURCE = 'nyc_taxi_data_raw'\n) as gtd;\n\n-- Record count for each file\nselect \nTOP 100\ngtd.filename() as filename ,\ncount(1) as RECORD_COUNT\nFrom  OPENROWSET(\n        BULK 'trip_data_green_parquet/year=*/month=*/*.parquet',\n        FORMAT = 'PARQUET',\n        DATA_SOURCE = 'nyc_taxi_data_raw'\n) as gtd\ngroup by gtd.filename()\norder by gtd.filename();\n\n-- Limting the data based on filename in where clause\nselect \nTOP 100\ngtd.filename() as filename ,\ncount(1) as RECORD_COUNT\nFrom  OPENROWSET(\n        BULK 'trip_data_green_parquet/year=*/month=*/*.parquet',\n        FORMAT = 'PARQUET',\n        DATA_SOURCE = 'nyc_taxi_data_raw'\n) as gtd\nwhere gtd.filename() in ('part-00000-tid-1069015557154220032-4ec3dcd3-545e-4d76-814f-e61930d9d012-133-1-c000.snappy.parquet',\n'part-00000-tid-2915260729203946702-45e02e93-498c-4412-8770-9795c5bf4c2a-118-1-c000.snappy.parquet'\n,'part-00000-tid-7369040652349253775-55a08cd7-e7e7-42bb-b933-15f17a65da9a-152-1-c000.snappy.parquet')\ngroup by gtd.filename()\norder by gtd.filename();\n\n-- Using the data based on filename in where clause\nselect \nTOP 100\ngtd.filename() as filename ,\ngtd.filepath() as filepath ,\ncount(1) as RECORD_COUNT\nFrom  OPENROWSET(\n        BULK 'trip_data_green_parquet/year=*/month=*/*.parquet',\n        FORMAT = 'PARQUET',\n        DATA_SOURCE = 'nyc_taxi_data_raw'\n) as gtd\nwhere gtd.filename() in ('part-00000-tid-1069015557154220032-4ec3dcd3-545e-4d76-814f-e61930d9d012-133-1-c000.snappy.parquet',\n'part-00000-tid-2915260729203946702-45e02e93-498c-4412-8770-9795c5bf4c2a-118-1-c000.snappy.parquet'\n,'part-00000-tid-7369040652349253775-55a08cd7-e7e7-42bb-b933-15f17a65da9a-152-1-c000.snappy.parquet')\ngroup by gtd.filename(), gtd.filepath()\norder by gtd.filename(), gtd.filepath();\n\n-- Using file path function along with parameters\nselect \nTOP 100\ngtd.filename() as filename ,\ngtd.filepath(1) as YEAR , -- based on the numerica value it will return the position of the wildcard character\ngtd.filepath(2) as MONTH ,\ncount(1) as record_count\nFrom OPENROWSET(\n        BULK 'trip_data_green_parquet/year=*/month=*/*.parquet',\n        FORMAT = 'PARQUET',\n        DATA_SOURCE = 'nyc_taxi_data_raw'\n) as gtd\nwhere gtd.filename() in ('part-00000-tid-1069015557154220032-4ec3dcd3-545e-4d76-814f-e61930d9d012-133-1-c000.snappy.parquet',\n'part-00000-tid-2915260729203946702-45e02e93-498c-4412-8770-9795c5bf4c2a-118-1-c000.snappy.parquet'\n,'part-00000-tid-7369040652349253775-55a08cd7-e7e7-42bb-b933-15f17a65da9a-152-1-c000.snappy.parquet')\ngroup by gtd.filename(), gtd.filepath(1), gtd.filepath(2)\norder by gtd.filename(), gtd.filepath(1), gtd.filepath(2);\n\n\n-- Using file path function along with parameters\nselect \nTOP 100\ngtd.filepath(1) as YEAR , -- based on the numerica value it will return the position of the wildcard character\ngtd.filepath(2) as MONTH ,\ncount(1) as record_count\nFrom OPENROWSET(\n        BULK 'trip_data_green_parquet/year=*/month=*/*.parquet',\n        FORMAT = 'PARQUET',\n        DATA_SOURCE = 'nyc_taxi_data_raw'\n) as gtd\nwhere gtd.filepath(1) = '2020'\nand gtd.filepath(2) in ('06','07','08') -- Using file path in where clause\ngroup by gtd.filepath(1), gtd.filepath(2)\norder by gtd.filepath(1), gtd.filepath(2);\n\n\n-- Query from sub folders\nselect \nTOP 100\ngtd.filename() as filename ,\ngtd.filepath() as filepath,\ngtd.filepath(1) as filepath_FIRST,\ncount(1) as record_count\nFrom OPENROWSET(\n        BULK 'trip_data_green_parquet/**',\n        FORMAT = 'PARQUET',\n        DATA_SOURCE = 'nyc_taxi_data_raw'\n) as gtd\ngroup by gtd.filename(),gtd.filepath(),gtd.filepath(1)\n;",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "nyc_taxi_discovery",
				"poolName": "Built-in"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}